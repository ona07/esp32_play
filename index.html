<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#f4efe4" />
  <title>ESP32 Power Logs</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f4efe4;
      --ink: #1e1b16;
      --muted: #6f675b;
      --panel: rgba(255, 255, 255, 0.8);
      --panel-strong: rgba(255, 255, 255, 0.95);
      --border: rgba(30, 27, 22, 0.12);
      --accent: #0f766e;
      --accent-2: #f97316;
      --accent-3: #1d4ed8;
      --success: #166534;
      --danger: #b91c1c;
      --shadow: 0 18px 40px rgba(21, 15, 6, 0.14);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
      color: var(--ink);
      background: var(--bg);
    }
    body::before, body::after {
      content: "";
      position: fixed;
      inset: -20vmax;
      z-index: -2;
      background:
        radial-gradient(40vmax 35vmax at 10% 10%, rgba(15, 118, 110, 0.16), transparent 60%),
        radial-gradient(30vmax 40vmax at 90% 15%, rgba(249, 115, 22, 0.18), transparent 60%),
        radial-gradient(35vmax 35vmax at 50% 90%, rgba(29, 78, 216, 0.12), transparent 60%);
      filter: blur(20px);
    }
    body::after {
      inset: -10vmax;
      z-index: -3;
      opacity: 0.6;
      background:
        linear-gradient(120deg, rgba(15, 118, 110, 0.08), rgba(249, 115, 22, 0.08)),
        repeating-linear-gradient(60deg, rgba(30, 27, 22, 0.02), rgba(30, 27, 22, 0.02) 12px, transparent 12px, transparent 24px);
    }

    header {
      padding: 28px 24px 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      font-size: clamp(20px, 3vw, 30px);
      letter-spacing: 0.3px;
    }
    header p {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--panel);
      font-size: 12px;
      font-weight: 600;
    }
    .status.ok { color: var(--success); border-color: rgba(22, 101, 52, 0.3); }
    .status.err { color: var(--danger); border-color: rgba(185, 28, 28, 0.3); }
    .status.wait { color: var(--accent-3); border-color: rgba(29, 78, 216, 0.3); }

    main {
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
      padding: 12px 24px 48px;
    }
    @media (min-width: 980px) {
      main { grid-template-columns: minmax(260px, 340px) minmax(0, 1fr); }
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      animation: rise 0.7s ease both;
    }
    .panel strong.title {
      display: block;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      font-size: 14px;
      letter-spacing: 0.2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .stack {
      display: grid;
      gap: 18px;
      animation: rise 0.7s ease both;
      animation-delay: 120ms;
    }
    @media (min-width: 980px) {
      .stack { grid-template-columns: 1fr; }
    }

    .config label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .config input, .config select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel-strong);
      font-size: 14px;
    }
    .config input:focus {
      outline: 2px solid rgba(15, 118, 110, 0.2);
      border-color: var(--accent);
    }

    .field {
      margin-bottom: 14px;
    }
    .field.inline {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: end;
    }

    button {
      padding: 10px 14px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      color: #fff;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 10px 20px rgba(15, 118, 110, 0.2);
    }
    button:hover { transform: translateY(-1px); }
    button.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--ink);
      box-shadow: none;
    }

    .pill {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(15, 118, 110, 0.12);
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      word-break: break-all;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    .metric-card {
      padding: 16px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.7);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4);
    }
    .metric-card h4 {
      margin: 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: var(--muted);
    }
    .metric-card .value {
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      font-size: 28px;
      font-weight: 700;
      margin: 8px 0 4px;
    }
    .metric-card .sub {
      font-size: 12px;
      color: var(--muted);
    }

    .chart-wrap {
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.65);
      border: 1px dashed rgba(30, 27, 22, 0.2);
      padding: 12px;
    }
    svg { width: 100%; height: 180px; display: block; }
    .chart-grid line { stroke: rgba(30, 27, 22, 0.08); }
    .chart-line { fill: none; stroke: var(--accent-3); stroke-width: 2.5; }
    .chart-area { fill: rgba(29, 78, 216, 0.14); }
    .chart-dot { fill: var(--accent-2); }
    .chart-select { stroke: rgba(15, 118, 110, 0.5); stroke-dasharray: 5 4; }

    .axis-row {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 8px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      align-items: center;
    }
    .axis-left { justify-self: start; }
    .axis-center { justify-self: center; color: var(--ink); font-weight: 600; }
    .axis-right { justify-self: end; }
    .axis-hint {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      text-align: left;
      padding: 8px 6px;
      border-bottom: 1px solid rgba(30, 27, 22, 0.08);
      font-variant-numeric: tabular-nums;
    }
    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--muted);
    }
    tbody tr:hover { background: rgba(15, 118, 110, 0.06); }

    .error {
      display: none;
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(185, 28, 28, 0.3);
      background: rgba(185, 28, 28, 0.08);
      color: var(--danger);
      font-size: 12px;
      white-space: pre-wrap;
    }

    .footer {
      margin-top: 18px;
      font-size: 12px;
      color: var(--muted);
    }

    @keyframes rise {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>ESP32 Power Logs</h1>
    </div>
    <div class="status wait" id="status">Idle</div>
  </header>

  <main>
    <section class="panel config">
      <strong class="title">Connection</strong>
      <div class="field">
        <label>REST URL</label>
        <div class="pill" id="restUrlLabel">--</div>
      </div>
      <div class="field">
        <label>API key</label>
        <div class="pill" id="apiKeyLabel">--</div>
      </div>
      <div class="field">
        <label>Device ID</label>
        <div class="pill" id="deviceIdLabel">--</div>
      </div>
      <div class="field inline">
        <div>
          <label>Rows</label>
          <div class="pill" id="limitLabel">--</div>
        </div>
        <button id="loadBtn">Load</button>
      </div>
      <div class="field">
        <label>
          <input id="autoRefresh" type="checkbox" />
          Auto refresh (60s)
        </label>
      </div>
      <div class="error" id="errorBox"></div>
      <div class="footer">
        Edit constants in <code>power_logs.html</code> to change values. Time display is fixed to Asia/Tokyo.
        <div style="margin-top:6px;">
          <a href="https://supabase.com/dashboard/project/kpjkxzsdknymopwpppfp/editor/64742?sort=recorded_at%3Aasc" target="_blank" rel="noreferrer">Open Supabase table</a>
        </div>
      </div>
    </section>

    <section class="stack">
      <section class="panel">
        <strong class="title">Latest</strong>
        <div class="metrics">
          <div class="metric-card">
            <h4>Voltage</h4>
            <div class="value" id="voltageVal">--</div>
            <div class="sub" id="voltageTs">--</div>
          </div>
          <div class="metric-card">
            <h4>Current</h4>
            <div class="value" id="currentVal">--</div>
            <div class="sub" id="currentTs">--</div>
          </div>
          <div class="metric-card">
            <h4>Power</h4>
            <div class="value" id="powerVal">--</div>
            <div class="sub" id="powerTs">--</div>
          </div>
        </div>
      </section>

      <section class="panel">
        <strong class="title">Power trend</strong>
        <div class="chart-wrap">
          <svg viewBox="0 0 600 200" role="img" aria-label="Power trend" id="sparkline">
            <defs>
              <linearGradient id="areaGrad" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="rgba(29, 78, 216, 0.25)"></stop>
                <stop offset="100%" stop-color="rgba(29, 78, 216, 0)"></stop>
              </linearGradient>
            </defs>
            <g class="chart-grid">
              <line x1="0" y1="40" x2="600" y2="40"></line>
              <line x1="0" y1="100" x2="600" y2="100"></line>
              <line x1="0" y1="160" x2="600" y2="160"></line>
            </g>
            <line id="sparkSelect" class="chart-select" x1="-10" x2="-10" y1="0" y2="200"></line>
            <path class="chart-area" d="" fill="url(#areaGrad)"></path>
            <path class="chart-line" d=""></path>
            <circle class="chart-dot" r="4" cx="-10" cy="-10"></circle>
          </svg>
        </div>
        <div class="axis-row">
          <span class="axis-left" id="axisStart">--</span>
          <span class="axis-center" id="axisSelected">--</span>
          <span class="axis-right" id="axisEnd">--</span>
        </div>
        <div class="axis-hint">Use left/right arrow keys to move the point.</div>
        <div class="metrics" style="margin-top: 12px;">
          <div class="metric-card">
            <h4>Min</h4>
            <div class="value" id="minVal">--</div>
            <div class="sub">Power mW</div>
          </div>
          <div class="metric-card">
            <h4>Avg</h4>
            <div class="value" id="avgVal">--</div>
            <div class="sub">Power mW</div>
          </div>
          <div class="metric-card">
            <h4>Max</h4>
            <div class="value" id="maxVal">--</div>
            <div class="sub">Power mW</div>
          </div>
        </div>
      </section>

      <section class="panel">
        <strong class="title">Recent rows</strong>
        <table>
          <thead>
            <tr>
              <th>Recorded (JST)</th>
              <th>Voltage (V)</th>
              <th>Current (mA)</th>
              <th>Power (mW)</th>
              <th>Device</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </section>
    </section>
  </main>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const statusEl = $('#status');
    const errorBox = $('#errorBox');
    const TZ = 'Asia/Tokyo';
    const CONFIG = Object.freeze({
      restUrl: 'https://kpjkxzsdknymopwpppfp.supabase.co/rest/v1/power_logs',
      apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtwamt4enNka255bW9wd3BwcGZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MjY0ODgsImV4cCI6MjA3MjEwMjQ4OH0.n1o1c50_iTL2rRYTAnITONXP4sma0gSl5xyihapArMI',
      deviceId: 'esp32-ina-001',
      limit: 2000
    });

    const fmtJst = new Intl.DateTimeFormat('en-GB', {
      timeZone: TZ,
      dateStyle: 'medium',
      timeStyle: 'medium'
    });
    const fmtAxis = new Intl.DateTimeFormat('ja-JP', {
      timeZone: TZ,
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });

    let refreshTimer = null;
    let sparkPoints = [];
    let sparkData = [];
    let sparkFrame = { top: 0, bottom: 0 };
    let selectedIndex = -1;

    const sparkSvg = $('#sparkline');
    const sparkLine = sparkSvg.querySelector('.chart-line');
    const sparkArea = sparkSvg.querySelector('.chart-area');
    const sparkDot = sparkSvg.querySelector('.chart-dot');
    const sparkSelect = $('#sparkSelect');
    const axisStartEl = $('#axisStart');
    const axisEndEl = $('#axisEnd');
    const axisSelectedEl = $('#axisSelected');

    function setStatus(msg, type) {
      statusEl.textContent = msg;
      statusEl.className = `status ${type}`;
    }

    function showError(msg) {
      if (!msg) {
        errorBox.style.display = 'none';
        errorBox.textContent = '';
        return;
      }
      errorBox.style.display = 'block';
      errorBox.textContent = msg;
    }

    function maskKey(key) {
      if (!key) return 'missing';
      if (key.length <= 10) return 'set';
      return `${key.slice(0, 6)}...${key.slice(-4)}`;
    }

    function applyConfig() {
      $('#restUrlLabel').textContent = CONFIG.restUrl || 'missing';
      $('#apiKeyLabel').textContent = CONFIG.apiKey ? `set (${maskKey(CONFIG.apiKey)})` : 'missing';
      $('#deviceIdLabel').textContent = CONFIG.deviceId || 'all devices';
      $('#limitLabel').textContent = String(CONFIG.limit || 0);
      const ready = !!(CONFIG.restUrl && CONFIG.apiKey);
      $('#loadBtn').disabled = !ready;
      if (!ready) {
        setStatus('Config missing', 'err');
        showError('Set CONFIG in power_logs.html before loading.');
      }
    }

    function configReady() {
      return !!(CONFIG.restUrl && CONFIG.apiKey);
    }

    function buildUrl() {
      if (!CONFIG.restUrl) throw new Error('REST URL is not set in CONFIG');
      const url = new URL(CONFIG.restUrl);
      const params = new URLSearchParams();
      params.set('select', 'recorded_at,voltage_v,current_ma,power_mw,device_id');
      params.set('order', 'recorded_at.desc');
      const limit = Math.min(Math.max(parseInt(CONFIG.limit || 120, 10), 10), 2000);
      params.set('limit', String(limit));
      if (CONFIG.deviceId) params.set('device_id', `eq.${CONFIG.deviceId}`);
      url.search = params.toString();
      return url.toString();
    }

    function fmtNum(v, digits = 2) {
      if (!Number.isFinite(v)) return '--';
      return v.toFixed(digits);
    }

    function fmtAxisTime(ts) {
      if (ts == null) return '--';
      const d = ts instanceof Date ? ts : new Date(ts);
      if (Number.isNaN(d.getTime())) return '--';
      return fmtAxis.format(d);
    }

    function fmtTime(ts) {
      if (!ts) return '--';
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return ts;
      return fmtJst.format(d);
    }

    function renderLatest(row) {
      if (!row) return;
      $('#voltageVal').textContent = `${fmtNum(Number(row.voltage_v), 3)} V`;
      $('#currentVal').textContent = `${fmtNum(Number(row.current_ma), 2)} mA`;
      $('#powerVal').textContent = `${fmtNum(Number(row.power_mw), 2)} mW`;
      const ts = fmtTime(row.recorded_at);
      $('#voltageTs').textContent = ts;
      $('#currentTs').textContent = ts;
      $('#powerTs').textContent = ts;
    }

    function renderTable(rows) {
      const body = $('#tableBody');
      body.innerHTML = '';
      rows.forEach((r) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtTime(r.recorded_at)}</td>
          <td>${fmtNum(Number(r.voltage_v), 3)}</td>
          <td>${fmtNum(Number(r.current_ma), 2)}</td>
          <td>${fmtNum(Number(r.power_mw), 2)}</td>
          <td>${r.device_id || '-'}</td>
        `;
        body.appendChild(tr);
      });
    }

    function renderStats(rows) {
      const values = rows.map(r => Number(r.power_mw)).filter(Number.isFinite);
      if (!values.length) {
        $('#minVal').textContent = '--';
        $('#avgVal').textContent = '--';
        $('#maxVal').textContent = '--';
        return;
      }
      const min = Math.min(...values);
      const max = Math.max(...values);
      const avg = values.reduce((a, b) => a + b, 0) / values.length;
      $('#minVal').textContent = fmtNum(min, 2);
      $('#avgVal').textContent = fmtNum(avg, 2);
      $('#maxVal').textContent = fmtNum(max, 2);
    }

    function renderSparkline(rows) {
      const data = rows
        .map(r => ({
          t: new Date(r.recorded_at).getTime(),
          v: Number(r.power_mw)
        }))
        .filter(p => Number.isFinite(p.t) && Number.isFinite(p.v))
        .sort((a, b) => a.t - b.t);
      sparkData = data;
      if (data.length < 2) {
        sparkLine.setAttribute('d', '');
        sparkArea.setAttribute('d', '');
        sparkDot.setAttribute('cx', -10);
        sparkDot.setAttribute('cy', -10);
        if (sparkSelect) {
          sparkSelect.setAttribute('x1', -10);
          sparkSelect.setAttribute('x2', -10);
        }
        sparkPoints = [];
        axisStartEl.textContent = '--';
        axisEndEl.textContent = '--';
        axisSelectedEl.textContent = '--';
        return;
      }
      const minX = Math.min(...data.map(d => d.t));
      const maxX = Math.max(...data.map(d => d.t));
      const minY = Math.min(...data.map(d => d.v));
      const maxY = Math.max(...data.map(d => d.v));
      const padX = 20;
      const padY = 16;
      const w = 600 - padX * 2;
      const h = 200 - padY * 2;
      const scaleX = (x) => padX + ((x - minX) / (maxX - minX || 1)) * w;
      const scaleY = (y) => padY + (1 - (y - minY) / (maxY - minY || 1)) * h;
      sparkFrame = { top: padY, bottom: padY + h };
      sparkPoints = data.map((d) => ({
        x: scaleX(d.t),
        y: scaleY(d.v),
        t: d.t,
        v: d.v
      }));
      const dLine = sparkPoints
        .map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x.toFixed(1)} ${p.y.toFixed(1)}`)
        .join(' ');
      const dArea = `${dLine} L ${sparkPoints[sparkPoints.length - 1].x.toFixed(1)} ${padY + h} L ${sparkPoints[0].x.toFixed(1)} ${padY + h} Z`;
      sparkLine.setAttribute('d', dLine);
      sparkArea.setAttribute('d', dArea);
      axisStartEl.textContent = fmtAxisTime(minX);
      axisEndEl.textContent = fmtAxisTime(maxX);
      if (selectedIndex < 0 || selectedIndex >= sparkPoints.length) {
        selectedIndex = sparkPoints.length - 1;
      }
      setSelection(selectedIndex);
    }

    function setSelection(nextIndex) {
      if (!sparkPoints.length) return;
      const clamped = Math.max(0, Math.min(nextIndex, sparkPoints.length - 1));
      selectedIndex = clamped;
      const p = sparkPoints[clamped];
      sparkDot.setAttribute('cx', p.x.toFixed(1));
      sparkDot.setAttribute('cy', p.y.toFixed(1));
      if (sparkSelect) {
        sparkSelect.setAttribute('x1', p.x.toFixed(1));
        sparkSelect.setAttribute('x2', p.x.toFixed(1));
        sparkSelect.setAttribute('y1', sparkFrame.top.toFixed(1));
        sparkSelect.setAttribute('y2', sparkFrame.bottom.toFixed(1));
      }
      axisSelectedEl.textContent = `${fmtAxisTime(p.t)} | ${fmtNum(p.v, 2)} mW`;
    }

    async function loadData() {
      showError('');
      setStatus('Loading', 'wait');
      if (!configReady()) {
        setStatus('Missing config', 'err');
        showError('CONFIG is missing. Edit power_logs.html.');
        return;
      }
      const apiKey = CONFIG.apiKey;
      let url = '';
      try {
        url = buildUrl();
      } catch (e) {
        setStatus('Bad config', 'err');
        showError(e.message);
        return;
      }
      try {
        const res = await fetch(url, {
          cache: 'no-store',
          headers: {
            apikey: apiKey,
            Authorization: `Bearer ${apiKey}`
          }
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`${res.status} ${res.statusText}\n${text}`);
        }
        const rows = await res.json();
        const arr = Array.isArray(rows) ? rows : [];
        renderLatest(arr[0]);
        renderTable(arr);
        renderStats(arr);
        renderSparkline([...arr].reverse());
        setStatus(`OK (${arr.length})`, 'ok');
      } catch (e) {
        setStatus('Error', 'err');
        showError(e.message || 'Fetch failed.');
      }
    }

    function setupAutoRefresh() {
      const enabled = $('#autoRefresh').checked;
      if (refreshTimer) {
        clearInterval(refreshTimer);
        refreshTimer = null;
      }
      if (enabled) {
        refreshTimer = setInterval(loadData, 60000);
      }
    }

    $('#loadBtn').addEventListener('click', loadData);
    $('#autoRefresh').addEventListener('change', setupAutoRefresh);

    applyConfig();

    window.addEventListener('keydown', (event) => {
      const active = document.activeElement;
      if (active && ['INPUT', 'TEXTAREA', 'SELECT'].includes(active.tagName)) return;
      if (event.key === 'ArrowLeft') {
        if (sparkPoints.length) {
          setSelection(selectedIndex - 1);
          event.preventDefault();
        }
      } else if (event.key === 'ArrowRight') {
        if (sparkPoints.length) {
          setSelection(selectedIndex + 1);
          event.preventDefault();
        }
      }
    });
  </script>
</body>
</html>
