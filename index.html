<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP32 Sensors Monitor</title>
  <meta name="description" content="ESP32 temperature / humidity / ultrasonic monitor UI for GitHub Pages" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root {
      --bg: #0b0c0f;
      --panel: #12141a;
      --muted: #9aa4b2;
      --text: #e6edf3;
      --accent: #4f8cff;
      --card: #171a21;
      --border: #232733;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
    }
    
    :root[data-theme="light"] {
      --bg: #fafafa; 
      --panel: #ffffff; 
      --card: #ffffff; 
      --text: #0a0a0a; 
      --muted: #57606a; 
      --border: #e5e7eb; 
      --accent: #1f6feb;
      --success: #198754;
      --warning: #f0ad4e;
      --danger: #dc3545;
    }
    
    @media (prefers-color-scheme: light) {
      :root:not([data-theme]) {
        --bg: #fafafa; --panel: #ffffff; --card:#ffffff; --text: #0a0a0a; --muted:#57606a; --border:#e5e7eb; --accent:#1f6feb;
      }
    }
    
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--text); font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; transition: background-color 0.3s ease, color 0.3s ease; }
    
    .container { max-width: 1100px; margin: 24px auto 80px; padding: 0 16px; }
    
    header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 12px; 
      margin-bottom: 16px; 
      flex-wrap: wrap;
    }
    header h1 { font-size: 20px; margin: 0; letter-spacing: .2px; }
    
    .header-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .theme-toggle {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      transition: all 0.3s ease;
    }
    
    .theme-toggle:hover {
      background: var(--accent);
      color: white;
    }
    
    .status-badge {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      min-width: 60px;
      text-align: center;
    }
    
    .status-badge.loading { border-color: var(--warning); color: var(--warning); }
    .status-badge.success { border-color: var(--success); color: var(--success); }
    .status-badge.error { border-color: var(--danger); color: var(--danger); }

    .panel { 
      background: var(--panel); 
      border: 1px solid var(--border); 
      border-radius: 14px; 
      padding: 16px; 
      box-shadow: 0 1px 0 rgba(0,0,0,.05), 0 8px 30px rgba(0,0,0,.15); 
      transition: all 0.3s ease;
    }

    .controls { 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 12px; 
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®æ”¹å–„ */
    @media (min-width: 480px) {
      .controls { grid-template-columns: 1fr 1fr; }
    }
    
    @media (min-width: 768px) {
      .controls { grid-template-columns: 1fr 1fr 1fr; }
    }
    
    @media (min-width: 980px) {
      .controls { grid-template-columns: 1.3fr .8fr 1fr 1fr 1fr 1.2fr; align-items: end; }
    }

    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; font-weight: 500; }
    
    input[type="text"], input[type="datetime-local"], select {
      width: 100%; 
      background: var(--card); 
      color: var(--text); 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      padding: 10px 12px; 
      box-sizing: border-box;
      font-size: 14px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(79, 140, 255, 0.1);
    }
    
    .metric-checks { 
      display: flex; 
      gap: 12px; 
      flex-wrap: wrap; 
      align-items: center; 
    }
    
    @media (max-width: 479px) {
      .metric-checks { flex-direction: column; align-items: flex-start; gap: 8px; }
    }
    
    .metric-checks label { 
      color: var(--text); 
      font-size: 14px; 
      margin: 0; 
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .btnrow { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 8px; 
      align-items: center; 
    }
    
    @media (max-width: 767px) {
      .btnrow { justify-content: center; }
      .btnrow label { margin-left: 0 !important; }
    }
    
    button { 
      background: var(--accent); 
      color: #fff; 
      border: none; 
      border-radius: 10px; 
      padding: 10px 14px; 
      cursor: pointer; 
      font-weight: 600; 
      letter-spacing: .2px;
      font-size: 14px;
      transition: all 0.3s ease;
      min-height: 40px;
    }
    
    button:hover:not(:disabled) { 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(79, 140, 255, 0.3);
    }
    
    button.secondary { 
      background: transparent; 
      color: var(--text); 
      border: 1px solid var(--border); 
    }
    
    button.secondary:hover:not(:disabled) {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    button.ghost { 
      background: transparent; 
      color: var(--muted); 
      border: 1px dashed var(--border); 
    }
    
    button.ghost:hover:not(:disabled) {
      color: var(--text);
      border-style: solid;
    }
    
    button:disabled { opacity: .6; cursor: not-allowed; transform: none !important; }

    .grid { 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 12px; 
      margin-top: 16px; 
    }
    
    @media (min-width: 840px) { 
      .grid { grid-template-columns: 1fr 1fr; } 
    }

    .cards { 
      display: grid; 
      grid-template-columns: repeat(1, minmax(0,1fr)); 
      gap: 12px; 
    }
    
    @media (min-width: 480px) { 
      .cards { grid-template-columns: repeat(2, minmax(0,1fr)); } 
    }
    
    @media (min-width: 620px) { 
      .cards { grid-template-columns: repeat(3, minmax(0,1fr)); } 
    }

    .card { 
      background: var(--card); 
      border: 1px solid var(--border); 
      border-radius: 14px; 
      padding: 14px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,.2);
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), #7c3aed);
    }
    
    .metric { 
      font-size: 12px; 
      color: var(--muted); 
      text-transform: uppercase; 
      letter-spacing: .5px; 
      font-weight: 600;
    }
    
    .value { 
      font-size: 28px; 
      font-weight: 700; 
      margin: 8px 0 6px; 
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .timestamp { 
      font-size: 12px; 
      color: var(--muted); 
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .zone { 
      font-size: 11px; 
      padding: 3px 8px; 
      border-radius: 999px; 
      border: 1px solid var(--border); 
      display: inline-block;
      background: var(--accent);
      color: white;
      font-weight: 500;
    }

    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
    }
    
    canvas { 
      width: 100% !important; 
      height: 100% !important; 
      border-radius: 8px;
    }

    .table-container {
      overflow: auto;
      max-height: 500px;
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      font-size: 13px; 
    }
    
    th, td { 
      padding: 12px 10px; 
      border-bottom: 1px solid var(--border); 
      text-align: left; 
    }
    
    th { 
      color: var(--muted); 
      font-weight: 600; 
      background: var(--card);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    tr:hover {
      background: rgba(79, 140, 255, 0.05);
    }

    .footer { 
      margin-top: 36px; 
      font-size: 12px; 
      color: var(--muted); 
      text-align: center;
    }

    .hint { 
      font-size: 12px; 
      color: var(--muted); 
      margin-top: 6px; 
      line-height: 1.4;
    }
    
    .errorbox { 
      margin-top: 8px; 
      border: 1px dashed var(--danger); 
      background: rgba(220, 53, 69, 0.1); 
      color: var(--danger); 
      padding: 12px; 
      border-radius: 10px; 
      display: none; 
      white-space: pre-wrap; 
      font-size: 13px;
      line-height: 1.4;
    }
    
    .env { 
      font-size: 11px; 
      color: var(--muted); 
      margin-top: 4px; 
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®æ”¹å–„ */
    @media (max-width: 767px) {
      .container { margin: 12px auto 60px; padding: 0 12px; }
      header { margin-bottom: 12px; }
      header h1 { font-size: 18px; }
      .panel { padding: 12px; }
      .chart-container { height: 300px; }
      
      /* ãƒœã‚¿ãƒ³ã‚’å¤§ããã—ã¦ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã */
      button {
        min-height: 44px;
        padding: 12px 16px;
        font-size: 15px;
      }
      
      /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚å¤§ãã */
      input, select {
        min-height: 44px;
        padding: 12px;
        font-size: 16px; /* iOSã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */
      }
    }
    
    /* è¶…å°å‹ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ */
    @media (max-width: 375px) {
      .btnrow {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btnrow button {
        width: 100%;
      }
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ  */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .panel {
      animation: fadeInUp 0.6s ease-out;
    }
    
    .card {
      animation: fadeInUp 0.6s ease-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ESP32 Sensors Monitor</h1>
      <div class="header-controls">
        <div class="theme-toggle" id="themeToggle">
          <span id="themeIcon">ğŸŒ™</span>
          <span id="themeText">Dark</span>
        </div>
        <div id="status" class="status-badge">ready</div>
      </div>
    </header>

    <section class="panel" id="config">
      <div class="controls">
        <div>
          <label>API Base URL</label>
          <input id="apiBase" type="text" placeholder="https://esp32-play.onrender.com" />
          <div class="hint">ä¾‹: https://esp32-play.onrender.comï¼ˆã‚µãƒ¼ãƒå´ã§ CORS ã‚’è¨±å¯ã—ã¦ãã ã•ã„ï¼‰</div>
          <div class="env">Origin: <span id="originTxt"></span></div>
        </div>
        <div>
          <label>Device ID</label>
          <select id="deviceSelect">
            <option value="232928c2-22a1-498d-aec0-71d0a48ee43a">ğŸ  Home Sensor (232928c2)</option>
            <option value="b8f3e412-9a7d-4c8f-8e2a-1b5c9d7f3e4a">ğŸ¢ Office Sensor (b8f3e412)</option>
            <option value="a1b2c3d4-5e6f-7g8h-9i0j-k1l2m3n4o5p6">ğŸŒ¡ï¸ Outdoor Sensor (a1b2c3d4)</option>
            <option value="f9e8d7c6-b5a4-9384-7261-504030201000">ğŸ”¬ Lab Sensor (f9e8d7c6)</option>
            <option value="custom">âœï¸ ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›...</option>
          </select>
          <input id="deviceIdCustom" type="text" placeholder="ã‚«ã‚¹ã‚¿ãƒ Device ID (UUID)" style="display: none; margin-top: 8px;" />
          <div class="hint">ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠã™ã‚‹ã‹ã€ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›ã§UUIDã‚’æŒ‡å®šã§ãã¾ã™ã€‚</div>
        </div>
        <div>
          <label>Start (local)</label>
          <input id="startAt" type="datetime-local" />
        </div>
        <div>
          <label>End (local)</label>
          <input id="endAt" type="datetime-local" />
        </div>
        <div>
          <label>Metrics</label>
          <div class="metric-checks">
            <label><input type="checkbox" class="metricChk" value="temperature" checked> æ¸©åº¦</label>
            <label><input type="checkbox" class="metricChk" value="humidity" checked> æ¹¿åº¦</label>
            <label><input type="checkbox" class="metricChk" value="distance_ultrasonic" checked> è¶…éŸ³æ³¢</label>
          </div>
        </div>
        <div>
          <label>Options</label>
          <div class="metric-checks">
            <label><input type="checkbox" id="mockMode"> ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼ˆAPIåˆ°é”ä¸å¯æ™‚ï¼‰</label>
          </div>
        </div>
      </div>
      <div class="btnrow" style="margin-top:12px;">
        <button id="loadBtn">èª­ã¿è¾¼ã‚€</button>
        <button class="secondary" data-quick="1h">ç›´è¿‘1æ™‚é–“</button>
        <button class="secondary" data-quick="6h">ç›´è¿‘6æ™‚é–“</button>
        <button class="secondary" data-quick="24h">ç›´è¿‘24æ™‚é–“</button>
        <button id="latestBtn" class="ghost">æœ€æ–°ã‚’æ›´æ–°</button>
        <button id="dlCsvBtn" class="ghost">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button id="pingBtn" class="ghost">APIç–é€š (Ping)</button>
        <button id="selfTestBtn" class="ghost">Self-Test</button>
        <label style="margin-left:auto; display:flex; align-items:center; gap:8px;">
          <input id="autoRefresh" type="checkbox"> è‡ªå‹•æ›´æ–°ï¼ˆLatestã®ã¿ï¼‰
        </label>
        <select id="autoInterval" style="width:160px;">
          <option value="15">15ç§’</option>
          <option value="30" selected>30ç§’</option>
          <option value="60">60ç§’</option>
        </select>
      </div>
      <div id="errorBox" class="errorbox"></div>
      <div class="hint">GitHub Pages ã§ Actions ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä½¿ã†å ´åˆã€ä¸‹ã® <b>Copy Pages Workflow</b> ãƒœã‚¿ãƒ³ã§æœ€å°æ§‹æˆã® YAML ã‚’ã‚³ãƒ”ãƒ¼ã§ãã¾ã™ã€‚</div>
      <div class="btnrow" style="margin-top:8px;">
        <button id="copyWorkflowBtn" class="ghost">Copy Pages Workflow</button>
      </div>
    </section>

    <div class="grid">
      <section class="panel">
        <h3 style="margin:0 0 16px; font-size:16px;">Latest</h3>
        <div class="cards" id="latestCards"><!-- cards injected here --></div>
      </section>
      <section class="panel">
        <h3 style="margin:0 0 16px; font-size:16px;">Chart</h3>
        <div class="chart-container">
          <canvas id="chart"></canvas>
        </div>
      </section>
    </div>

    <section class="panel" style="margin-top:12px;">
      <h3 style="margin:0 0 16px; font-size:16px;">Series Table</h3>
      <div class="table-container">
        <table id="seriesTable">
          <thead>
            <tr><th>æ™‚åˆ»</th><th>ãƒ¡ãƒˆãƒªãƒƒã‚¯</th><th>å€¤</th><th>ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <div class="footer">è¡¨ç¤ºæ™‚åˆ»ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆJSTæ¨å¥¨ï¼‰ã€‚</div>
  </div>

  <!-- Chart.js + date adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <script type="application/json" id="pages-workflow">{
"yaml": "name: Deploy static to Pages\non:\n  push:\n    branches: [ main ]\n\npermissions:\n  pages: write\n  id-token: write\n\nconcurrency:\n  group: \"pages\"\n  cancel-in-progress: true\n\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/upload-pages-artifact@v3\n        with:\n          path: '.'\n  deploy:\n    needs: build\n    runs-on: ubuntu-latest\n    environment:\n      name: github-pages\n      url: ${{ steps.deployment.outputs.page_url }}\n    steps:\n      - id: deployment\n        uses: actions/deploy-pages@v4\n"}</script>

  <script>
    // ===== Theme Management =====
    function initTheme() {
      const saved = localStorage.getItem('esp32mon:theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      setTheme(theme);
    }

    function setTheme(theme) {
      const root = document.documentElement;
      const themeIcon = document.getElementById('themeIcon');
      const themeText = document.getElementById('themeText');
      
      if (theme === 'dark') {
        root.setAttribute('data-theme', 'dark');
        themeIcon.textContent = 'ğŸŒ™';
        themeText.textContent = 'Dark';
      } else {
        root.setAttribute('data-theme', 'light');
        themeIcon.textContent = 'â˜€ï¸';
        themeText.textContent = 'Light';
      }
      
      localStorage.setItem('esp32mon:theme', theme);
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const newTheme = current === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    }

    function getSelectedDeviceId() {
      const select = $('#deviceSelect');
      const customInput = $('#deviceIdCustom');
      
      if (select.value === 'custom') {
        return customInput.value.trim();
      }
      return select.value;
    }
    
    function updateDeviceDisplay() {
      const select = $('#deviceSelect');
      const customInput = $('#deviceIdCustom');
      
      if (select.value === 'custom') {
        customInput.style.display = 'block';
        customInput.focus();
      } else {
        customInput.style.display = 'none';
      }
      savePrefs();
    }
    
    // ===== Utilities =====
    const $ = (sel) => document.querySelector(sel);
    const $ = (sel) => Array.from(document.querySelectorAll(sel));
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼é–¢æ•°ã®ãƒ†ã‚¹ãƒˆ
    console.log('Testing selectors:');
    console.log('$ function:', typeof $);
    console.log('$ function:', typeof $);
    console.log('Test $(".metricChk"):', $('.metricChk'));

    function toISOZFromLocalInput(v){
      if(!v) return null;
      const d = new Date(v); // local
      return d.toISOString(); // UTC Z
    }
    function fromDateToLocalInputValue(d){
      const pad = (n) => String(n).padStart(2,'0');
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth()+1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const ii = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${ii}`;
    }

    function fmtMetric(m){
      if(m==='temperature') return 'æ¸©åº¦';
      if(m==='humidity') return 'æ¹¿åº¦';
      if(m==='distance_ultrasonic') return 'è¶…éŸ³æ³¢è·é›¢';
      return m;
    }
    function fmtValue(metric, v){
      if(v==null || Number.isNaN(v)) return '-';
      if(metric==='temperature') return `${v.toFixed(1)} Â°C`;
      if(metric==='humidity') return `${v.toFixed(1)} %`;
      if(metric==='distance_ultrasonic') return `${v.toFixed(1)} cm`;
      return String(v);
    }

    function savePrefs(){
      const prefs = {
        apiBase: $('#apiBase').value.trim(),
        deviceSelect: $('#deviceSelect').value,
        deviceIdCustom: $('#deviceIdCustom').value.trim(),
        startAt: $('#startAt').value,
        endAt: $('#endAt').value,
        metrics: $('.metricChk').filter(c=>c.checked).map(c=>c.value),
        auto: $('#autoRefresh').checked,
        interval: $('#autoInterval').value,
        mock: $('#mockMode') ? $('#mockMode').checked : false,
      };
      localStorage.setItem('esp32mon:prefs', JSON.stringify(prefs));
    }
    
    function loadPrefs(){
      const raw = localStorage.getItem('esp32mon:prefs');
      if(!raw) return;
      try{
        const p = JSON.parse(raw);
        if(p.apiBase) $('#apiBase').value = p.apiBase;
        if(p.deviceSelect) $('#deviceSelect').value = p.deviceSelect;
        if(p.deviceIdCustom) $('#deviceIdCustom').value = p.deviceIdCustom;
        if(p.startAt) $('#startAt').value = p.startAt;
        if(p.endAt) $('#endAt').value = p.endAt;
        if(Array.isArray(p.metrics)) $('.metricChk').forEach(c=> c.checked = p.metrics.includes(c.value));
        if(typeof p.auto==='boolean') $('#autoRefresh').checked = p.auto;
        if(p.interval) $('#autoInterval').value = p.interval;
        if(typeof p.mock==='boolean' && $('#mockMode')) $('#mockMode').checked = p.mock;
        
        // ãƒ‡ãƒã‚¤ã‚¹é¸æŠã®è¡¨ç¤ºæ›´æ–°
        updateDeviceDisplay();
      }catch(e){ console.warn('prefs parse fail', e); }
    }

    function setStatus(msg, type = 'default'){ 
      const statusEl = $('#status');
      statusEl.textContent = msg;
      statusEl.className = `status-badge ${type}`;
    }
    function showError(msg){ 
      const box = $('#errorBox'); 
      box.textContent = msg; 
      box.style.display = msg ? 'block' : 'none'; 
    }

    function buildBase(){
      let b = $('#apiBase').value.trim() || 'https://esp32-play.onrender.com';
      if(b.endsWith('/')) b = b.slice(0,-1);
      return b;
    }

    // ===== Chart with Enhanced Tooltips =====
    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: { datasets: [] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { 
          mode: 'nearest', 
          intersect: false,
          axis: 'x'
        },
        parsing: false,
        scales: {
          x: { 
            type: 'time', 
            time: { 
              tooltipFormat: 'yyyy-LL-dd HH:mm:ss',
              displayFormats: {
                minute: 'HH:mm',
                hour: 'MM/dd HH:mm',
                day: 'MM/dd'
              }
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            }
          },
          y: { 
            title: { display: true, text: 'Temp/Humidity', color: '#9aa4b2' },
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            }
          },
          y2: { 
            position: 'right', 
            grid: { drawOnChartArea: false }, 
            title: { display: true, text: 'Distance (cm)', color: '#9aa4b2' }
          }
        },
        plugins: { 
          legend: { 
            display: true,
            labels: {
              color: '#e6edf3',
              usePointStyle: true,
              padding: 20
            }
          },
          tooltip: {
            backgroundColor: 'rgba(18, 20, 26, 0.95)',
            titleColor: '#e6edf3',
            bodyColor: '#e6edf3',
            borderColor: '#232733',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: true,
            callbacks: {
              title: function(context) {
                const date = new Date(context[0].parsed.x);
                return `ğŸ“… ${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP')}`;
              },
              label: function(context) {
                const value = context.parsed.y;
                const metric = context.dataset.label;
                let icon = 'ğŸ“Š';
                
                if (metric.includes('æ¸©åº¦')) {
                  icon = value > 25 ? 'ğŸ”¥' : value < 15 ? 'â„ï¸' : 'ğŸŒ¡ï¸';
                } else if (metric.includes('æ¹¿åº¦')) {
                  icon = value > 70 ? 'ğŸ’§' : value < 30 ? 'ğŸœï¸' : 'ğŸ’¨';
                } else if (metric.includes('è·é›¢')) {
                  icon = value > 50 ? 'ğŸ“' : 'ğŸ“';
                }
                
                return `${icon} ${metric}: ${value.toFixed(1)} ${getUnit(metric)}`;
              },
              footer: function(context) {
                return `ğŸ“ Device: ${getSelectedDeviceId().substring(0, 8)}...`;
              }
            }
          }
        },
        elements: {
          line: {
            tension: 0.4,
            borderWidth: 3
          },
          point: {
            radius: 4,
            hoverRadius: 8,
            borderWidth: 2,
            backgroundColor: '#ffffff'
          }
        }
      }
    });

    function getUnit(metric) {
      if (metric.includes('æ¸©åº¦')) return 'Â°C';
      if (metric.includes('æ¹¿åº¦')) return '%';
      if (metric.includes('è·é›¢')) return 'cm';
      return '';
    }

    function setDatasets(series, selected){
      const groups = { temperature: [], humidity: [], distance_ultrasonic: [] };
      const colors = {
        temperature: { border: '#ff6b6b', background: 'rgba(255, 107, 107, 0.1)' },
        humidity: { border: '#4ecdc4', background: 'rgba(78, 205, 196, 0.1)' },
        distance_ultrasonic: { border: '#ffa726', background: 'rgba(255, 167, 38, 0.1)' }
      };
      
      for(const r of series){
        if(!selected.includes(r.metric)) continue;
        const x = new Date(r.ts).getTime();
        const y = Number(r.value);
        if(Number.isFinite(y)) groups[r.metric].push({ x, y });
      }
      
      const datasets = [];
      if(selected.includes('temperature')) {
        datasets.push({
          label: 'æ¸©åº¦ (Â°C)',
          data: groups.temperature,
          yAxisID: 'y',
          borderColor: colors.temperature.border,
          backgroundColor: colors.temperature.background,
          fill: true
        });
      }
      if(selected.includes('humidity')) {
        datasets.push({
          label: 'æ¹¿åº¦ (%)',
          data: groups.humidity,
          yAxisID: 'y',
          borderColor: colors.humidity.border,
          backgroundColor: colors.humidity.background,
          fill: true
        });
      }
      if(selected.includes('distance_ultrasonic')) {
        datasets.push({
          label: 'è·é›¢ (cm)',
          data: groups.distance_ultrasonic,
          yAxisID: 'y2',
          borderColor: colors.distance_ultrasonic.border,
          backgroundColor: colors.distance_ultrasonic.background,
          fill: true
        });
      }
      
      chart.data.datasets = datasets;
      chart.update();
    }

    function renderTable(series){
      const tbody = $('#seriesTable tbody');
      tbody.innerHTML = '';
      const rows = series.map(r => {
        const tr = document.createElement('tr');
        const metaTxt = r.meta ? JSON.stringify(r.meta) : '';
        const date = new Date(r.ts);
        const formattedDate = `${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP')}`;
        const metricName = fmtMetric(r.metric);
        const formattedValue = fmtValue(r.metric, Number(r.value));
        
        tr.innerHTML = `
          <td>${formattedDate}</td>
          <td><span style="color: var(--accent); font-weight: 600;">${metricName}</span></td>
          <td><strong>${formattedValue}</strong></td>
          <td><code style="font-size: 11px; color: var(--muted);">${metaTxt}</code></td>
        `;
        return tr;
      });
      rows.forEach(tr => tbody.appendChild(tr));
    }

    function renderLatest(cards){
      const wrap = $('#latestCards');
      wrap.innerHTML = '';
      for(const r of cards){
        const meta = r.meta || {};
        const zone = meta.zone ? String(meta.zone) : '';
        const zonePill = zone ? `<span class="zone">${zone}</span>` : '';
        const div = document.createElement('div');
        div.className = 'card';
        
        // ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
        let icon = 'ğŸ“Š';
        const value = Number(r.value);
        if (r.metric === 'temperature') {
          icon = value > 25 ? 'ğŸ”¥' : value < 15 ? 'â„ï¸' : 'ğŸŒ¡ï¸';
        } else if (r.metric === 'humidity') {
          icon = value > 70 ? 'ğŸ’§' : value < 30 ? 'ğŸœï¸' : 'ğŸ’¨';
        } else if (r.metric === 'distance_ultrasonic') {
          icon = value > 50 ? 'ğŸ“' : 'ğŸ“';
        }
        
        div.innerHTML = `
          <div class="metric">${icon} ${fmtMetric(r.metric)}</div>
          <div class="value">${fmtValue(r.metric, value)}</div>
          <div class="timestamp">
            <span>â° ${new Date(r.ts).toLocaleString()}</span>
            ${zonePill}
          </div>
        `;
        wrap.appendChild(div);
      }
    }

    function makeCSV(series){
      const header = ['ts','metric','value','meta'];
      const lines = [header.join(',')];
      for(const r of series){
        const meta = r.meta ? JSON.stringify(r.meta).replace(/\"/g,'\"\"') : '';
        const row = [r.ts, r.metric, r.value, `"${meta}"`];
        lines.push(row.join(','));
      }
      return lines.join('\n');
    }

    function download(filename, text){
      const blob = new Blob([text], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ===== Mock data (optional) =====
    function generateMockSeries(start, end){
      const out = [];
      const ms = 60*1000;
      for(let t = start.getTime(); t < end.getTime(); t += 5*ms){
        const d = new Date(t);
        const base = 20 + 5*Math.sin(t/3.6e6);
        out.push({ ts: d.toISOString(), metric: 'temperature', value: +(base + (Math.random()-0.5)).toFixed(1), meta: { unit:'C', mock:true } });
        out.push({ ts: d.toISOString(), metric: 'humidity', value: +(55 + 10*Math.cos(t/3.6e6) + (Math.random()-0.5)).toFixed(1), meta: { unit:'%', mock:true } });
        out.push({ ts: d.toISOString(), metric: 'distance_ultrasonic', value: +(50 + 20*Math.sin(t/1.8e6) + (Math.random()-0.5)).toFixed(1), meta: { unit:'cm', mock:true } });
      }
      return out;
    }
    
    function generateMockLatest(){
      const now = new Date();
      return [
        { device_id: 1, ts: now.toISOString(), metric: 'temperature', value: 24.2, meta:{ unit:'C', mock:true } },
        { device_id: 1, ts: now.toISOString(), metric: 'humidity', value: 59.1, meta:{ unit:'%', mock:true } },
        { device_id: 1, ts: now.toISOString(), metric: 'distance_ultrasonic', value: 32.5, meta:{ unit:'cm', zone:'OVER_EQ_20cm', mock:true } },
      ];
    }

    // ===== Fetch helpers (direct only) =====
    const controllers = { latest: null, series: null };
    async function fetchJSON(url, key){
      const controller = new AbortController();
      if(key){ if(controllers[key]) controllers[key].abort(); controllers[key] = controller; }
      const res = await fetch(url, { signal: controller.signal, cache:'no-store', mode:'cors' });
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const json = await res.json();
      setStatus(`${key||'fetch'} ok`, 'success');
      return json;
    }

    async function loadLatest(){
      const base = buildBase();
      const deviceId = ($('#deviceId').value || '').trim();
      if(!deviceId){ showError('Device ID ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæ•´æ•° or UUIDï¼‰'); return; }
      setStatus('loading latestâ€¦', 'loading'); 
      showError('');
      
      try{
        const j = await fetchJSON(`${base}/latest?device_id=${encodeURIComponent(deviceId)}`, 'latest');
        renderLatest(j.data || []);
        setStatus('latest ok', 'success');
      }catch(e){
        console.error('latest error', e);
        if($('#mockMode') && $('#mockMode').checked){
          renderLatest(generateMockLatest());
          setStatus('latest mock', 'success');
          showError(`æœ€æ–°å€¤ã®å–å¾—ã«å¤±æ•—: ${e.message}. ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­ã€‚`);
        } else {
          setStatus('latest error', 'error');
          const isFile = location.protocol === 'file:' || location.origin === 'null';
          const tip = isFile ? '\nâ€» ç¾åœ¨ file:// ã‹ã‚‰é–‹ã„ã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶ç´„ã§ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ã®å–å¾—ãŒå¤±æ•—ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚GitHub Pages ãªã© HTTPS ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚' : '';
          showError(`æœ€æ–°å€¤ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åŸå› ä¾‹: device_id ä¸ä¸€è‡´ / ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ / URL / ã‚µãƒ¼ãƒåœæ­¢ / CORSï¼ˆã‚µãƒ¼ãƒå´ã§è¨±å¯ãŒå¿…è¦ï¼‰ã€‚\nè©³ç´°: ${e instanceof DOMException ? e.name : e.message}${tip}`);
        }
      }
    }

    async function loadSeries(){
      const base = buildBase();
      const deviceId = ($('#deviceId').value || '').trim();
      if(!deviceId){ showError('Device ID ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæ•´æ•° or UUIDï¼‰'); return; }
      const startISO = toISOZFromLocalInput($('#startAt').value);
      const endISO = toISOZFromLocalInput($('#endAt').value);
      const selected = $('.metricChk').filter(c=>c.checked).map(c=>c.value);
      if(!startISO || !endISO){ setStatus('start/endæœªè¨­å®š', 'error'); return; }
      
      setStatus('loading seriesâ€¦', 'loading'); 
      showError('');
      const url = `${base}/series?device_id=${encodeURIComponent(deviceId)}&start=${encodeURIComponent(startISO)}&end=${encodeURIComponent(endISO)}`;
      
      try{
        const j = await fetchJSON(url, 'series');
        const all = Array.isArray(j.data) ? j.data : [];
        const filtered = all.filter(r => selected.includes(r.metric));
        setDatasets(filtered, selected);
        renderTable(filtered);
        window.__lastSeries = filtered;
        setStatus(`series ok (${filtered.length} points)`, 'success');
      }catch(e){
        console.error('series error', e);
        if($('#mockMode') && $('#mockMode').checked){
          const start = new Date($('#startAt').value);
          const end = new Date($('#endAt').value);
          const mock = generateMockSeries(start, end);
          const filtered = mock.filter(r => selected.includes(r.metric));
          setDatasets(filtered, selected);
          renderTable(filtered);
          window.__lastSeries = filtered;
          setStatus(`series mock (${filtered.length} points)`, 'success');
          showError(`æ™‚ç³»åˆ—ã®å–å¾—ã«å¤±æ•—: ${e.message}. ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­ã€‚`);
        } else {
          setStatus('series error', 'error');
          const isFile = location.protocol === 'file:' || location.origin === 'null';
          const tip = isFile ? '\nâ€» ç¾åœ¨ file:// ã‹ã‚‰é–‹ã„ã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶ç´„ã§ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ã®å–å¾—ãŒå¤±æ•—ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚GitHub Pages ãªã© HTTPS ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚' : '';
          showError(`æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åŸå› ä¾‹: device_id ä¸ä¸€è‡´ / ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ / URL / ã‚µãƒ¼ãƒåœæ­¢ / CORSï¼ˆã‚µãƒ¼ãƒå´ã§è¨±å¯ãŒå¿…è¦ï¼‰ã€‚\nè©³ç´°: ${e instanceof DOMException ? e.name : e.message}${tip}`);
        }
      }
    }

    // ===== Ping & Self-Test =====
    async function pingApi(){
      const base = buildBase();
      const deviceId = getSelectedDeviceId();
      if(!deviceId){ 
        alert('Device ID ã‚’é¸æŠã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„'); 
        return; 
      }
      const url = `${base}/latest?device_id=${encodeURIComponent(deviceId)}`;
      setStatus('pingâ€¦', 'loading'); 
      showError('');
      
      try{
        const res = await fetch(url, { cache:'no-store', mode:'cors' });
        if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const j = await res.json();
        setStatus('ping ok', 'success');
        alert('ğŸ‰ Ping OK\n' + JSON.stringify(j, null, 2));
      }catch(e){
        setStatus('ping error', 'error');
        showError(`âŒ Pingå¤±æ•—ã€‚CORS ã¾ãŸã¯åˆ°é”æ€§ã®å•é¡Œã®å¯èƒ½æ€§ã€‚\n- ã‚µãƒ¼ãƒå´ã§ CORS ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚\nOrigin: ${location.origin || 'null'}`);
      }
    }

    function selfTests(){
      const results = [];
      const assert = (name, cond) => results.push({ name, pass: !!cond });

      // Test 1: ISO convertï¼ˆåˆ†ç²¾åº¦ï¼‰
      const now = new Date(); now.setSeconds(0,0);
      const loc = fromDateToLocalInputValue(now);
      const iso = toISOZFromLocalInput(loc);
      assert('ISO conversion returns string', typeof iso === 'string' && iso.endsWith('Z'));

      // Test 2: buildBase trims slash
      $('#apiBase').value = 'https://esp32-play.onrender.com/';
      assert('buildBase trims trailing slash', buildBase() === 'https://esp32-play.onrender.com');

      // Test 3: setDatasets empty ok
      try { setDatasets([], ['temperature']); assert('setDatasets empty ok', true); } catch(e) { assert('setDatasets empty ok', false); }

      // Test 4: mock generators
      const start = new Date(Date.now()-3600*1000), end = new Date();
      const mockS = generateMockSeries(start, end);
      assert('mock series non-empty', Array.isArray(mockS) && mockS.length>0);
      const mockL = generateMockLatest();
      assert('mock latest length=3', Array.isArray(mockL) && mockL.length===3);

      // Test 5: autoTick should call ONLY latest
      const origLatest = window.loadLatest; const origSeries = window.loadSeries;
      let cntLatest = 0, cntSeries = 0;
      window.loadLatest = async ()=>{ cntLatest++; };
      window.loadSeries = async ()=>{ cntSeries++; };
      try { autoTick(); } finally { window.loadLatest = origLatest; window.loadSeries = origSeries; }
      assert('autoTick only latest', cntLatest===1 && cntSeries===0);

      // Test 6: Theme switching
      const currentTheme = document.documentElement.getAttribute('data-theme');
      toggleTheme();
      const newTheme = document.documentElement.getAttribute('data-theme');
      assert('theme toggle works', currentTheme !== newTheme);
      toggleTheme(); // restore

      const pass = results.filter(r=>r.pass).length;
      const fail = results.length - pass;
      console.table(results);
      alert(`ğŸ§ª Self-Test: ${pass} passed, ${fail} failed\n\n${results.map(r => `${r.pass ? 'âœ…' : 'âŒ'} ${r.name}`).join('\n')}`);
    }

    // ===== Auto refresh (Latest only) =====
    let autoTimer = null;
    function autoTick(){ loadLatest(); } // Seriesã¯æ‰‹å‹• or åˆå›ã®ã¿
    function setupAuto(){
      if(autoTimer){ clearInterval(autoTimer); autoTimer = null; }
      if($('#autoRefresh').checked){
        const sec = parseInt($('#autoInterval').value,10) || 30;
        autoTimer = setInterval(()=>{ autoTick(); }, sec*1000);
      }
      savePrefs();
    }

    // ===== Events =====
    $('#themeToggle').addEventListener('click', toggleTheme);
    $('#deviceSelect').addEventListener('change', updateDeviceDisplay);
    $('#deviceIdCustom').addEventListener('input', savePrefs);
    $('#loadBtn').addEventListener('click', () => { savePrefs(); loadLatest(); loadSeries(); });
    $('#latestBtn').addEventListener('click', () => { savePrefs(); loadLatest(); });
    $('#pingBtn').addEventListener('click', () => { savePrefs(); pingApi(); });
    $('#selfTestBtn').addEventListener('click', selfTests);

    $('#config input, #config select').forEach(el => el.addEventListener('change', savePrefs));

    $('#config button.secondary[data-quick]').forEach(btn => btn.addEventListener('click', (e)=>{
      const now = new Date();
      const k = e.currentTarget.getAttribute('data-quick');
      const map = { '1h': 1, '6h': 6, '24h': 24 };
      const hours = map[k] || 6;
      const start = new Date(now.getTime() - hours*3600*1000);
      $('#endAt').value = fromDateToLocalInputValue(now);
      $('#startAt').value = fromDateToLocalInputValue(start);
      savePrefs();
      loadSeries();
    }));

    $('#dlCsvBtn').addEventListener('click', ()=>{
      const rows = window.__lastSeries || [];
      if(!rows.length){ alert('ğŸ“„ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      const csv = makeCSV(rows);
      const deviceId = getSelectedDeviceId() || 'device';
      const deviceName = deviceId.length > 10 ? deviceId.substring(0, 8) : deviceId;
      download(`series_${deviceName}.csv`, csv);
      alert('ğŸ“¥ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
    });

    $('#autoRefresh').addEventListener('change', setupAuto);
    $('#autoInterval').addEventListener('change', setupAuto);

    // Copy minimal workflow to clipboard
    document.addEventListener('click', (e)=>{
      if(e.target && e.target.id === 'copyWorkflowBtn'){
        try{
          const obj = JSON.parse(document.getElementById('pages-workflow').textContent);
          navigator.clipboard.writeText(obj.yaml).then(()=>{
            alert('ğŸ“‹ Copied pages.yml to clipboard!\nâ†’ ãƒªãƒã‚¸ãƒˆãƒªã« .github/workflows/pages.yml ã¨ã—ã¦ä¿å­˜ã—ã€Settings â†’ Pages ã§ Source ã‚’ GitHub Actions ã«ã—ã¦ãã ã•ã„ã€‚');
          });
        }catch(err){
          alert('âŒ Copy failed: '+ String(err));
        }
      }
    });

    // ===== Mobile Enhancement =====
    // Add touch feedback
    document.addEventListener('touchstart', (e) => {
      if (e.target.tagName === 'BUTTON') {
        e.target.style.transform = 'scale(0.95)';
      }
    });

    document.addEventListener('touchend', (e) => {
      if (e.target.tagName === 'BUTTON') {
        setTimeout(() => {
          e.target.style.transform = '';
        }, 150);
      }
    });

    // Prevent zoom on input focus (iOS)
    const inputs = $('input, select');
    inputs.forEach(input => {
      input.addEventListener('focus', (e) => {
        if (window.innerWidth < 768) {
          setTimeout(() => {
            e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        }
      });
    });

    // ===== Init =====
    function initDefaults(){
      if(!$('#apiBase').value) $('#apiBase').value = 'https://esp32-play.onrender.com';
      
      // ãƒ‡ãƒã‚¤ã‚¹é¸æŠã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
      if(!$('#deviceSelect').value) {
        $('#deviceSelect').value = '232928c2-22a1-498d-aec0-71d0a48ee43a';
      }
      updateDeviceDisplay();
      
      const now = new Date();
      const start = new Date(now.getTime() - 6*3600*1000);
      $('#endAt').value = fromDateToLocalInputValue(now);
      $('#startAt').value = fromDateToLocalInputValue(start);
      $('#originTxt').textContent = location.origin || 'null';
      
      // file:// ã§é–‹ã„ãŸã‚‰è­¦å‘Š
      if(location.protocol === 'file:' || location.origin === 'null'){
        showError('âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ« file:// ã‹ã‚‰é–‹ã„ã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶åˆ¶ç´„ã«ã‚ˆã‚Š API å–å¾—ãŒå¤±æ•—ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚GitHub Pages ãªã© HTTPS ã§ãƒ›ã‚¹ãƒˆã—ã¦é–‹ã„ã¦ãã ã•ã„ã€‚');
      }
    }

    // ===== Startup =====
    console.log('Initializing ESP32 Monitor...');
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼é–¢æ•°ã®ãƒ†ã‚¹ãƒˆ
    console.log('Testing selectors:');
    console.log('$ function:', typeof $);
    console.log('$ function:', typeof $);
    console.log('Test $(".metricChk"):', $('.metricChk'));
    
    try {
      initTheme();
      console.log('Theme initialized');
      
      loadPrefs();
      console.log('Preferences loaded');
      
      initDefaults();
      console.log('Defaults initialized');
      
      savePrefs();
      console.log('Preferences saved');
      
      // åˆå›ã®ã¿: Latest + Series ã‚’èª­ã¿è¾¼ã¿ï¼ˆä»¥å¾Œ Series ã¯æ‰‹å‹•ï¼‰
      loadLatest();
      loadSeries();
      setupAuto();
      
      console.log('Initial load completed');
    } catch (error) {
      console.error('Initialization error:', error);
      showError(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
    }

    // Add loading animation
    document.body.style.opacity = '0';
    window.addEventListener('load', () => {
      document.body.style.transition = 'opacity 0.5s ease';
      document.body.style.opacity = '1';
      console.log('Page fully loaded');
    });
  </script>
</body>
</html>